---
#
#  Author: Michael De La Rue
#  based on aws_lambda test cases
- block:

     # ============================================================
     - name: Create or update key/value pair in aws parameter store
       aws_ssm_parameter_store:
         name: "/{{ssm_key_prefix}}/Hello"
         description: "This is your first key"
         value: "World"
         ec2_access_key: '{{ec2_access_key}}'
         ec2_secret_key: '{{ec2_secret_key}}'
         security_token: '{{security_token}}'
         region: '{{ec2_region}}'

     - name: Check that parameter was stored correctly
       assert:
        that:
         - "'{{lookup('aws_ssm', '/' ~ ssm_key_prefix ~ '/Hello', region=ec2_region, aws_access_key=ec2_access_key, aws_secret_key=ec2_secret_key, aws_security_token=security_token )}}' == 'World'"

     # ============================================================
     - name: Create or update key/value pair in aws parameter store
       aws_ssm_parameter_store:
         name: "/{{ssm_key_prefix}}/path/wonvar"
         description: "This is your first key"
         value: "won value"
         ec2_access_key: '{{ec2_access_key}}'
         ec2_secret_key: '{{ec2_secret_key}}'
         security_token: '{{security_token}}'
         region: '{{ec2_region}}'

     - name: Create or update key/value pair in aws parameter store
       aws_ssm_parameter_store:
         name: "/{{ssm_key_prefix}}/path/toovar"
         description: "This is your first key"
         value: "too value"
         ec2_access_key: '{{ec2_access_key}}'
         ec2_secret_key: '{{ec2_secret_key}}'
         security_token: '{{security_token}}'
         region: '{{ec2_region}}'

     - name: Create or update key/value pair in aws parameter store
       aws_ssm_parameter_store:
         name: "/{{ssm_key_prefix}}/path/tree/treevar"
         description: "This is your first key"
         value: "tree value"
         ec2_access_key: '{{ec2_access_key}}'
         ec2_secret_key: '{{ec2_secret_key}}'
         security_token: '{{security_token}}'
         region: '{{ec2_region}}'

     - name: debug the lookup
       debug:
        msg: "{{lookup('aws_ssm', '/' ~ ssm_key_prefix ~ '/path', region=ec2_region, aws_access_key=ec2_access_key, aws_secret_key=ec2_secret_key, aws_security_token=security_token, bypath=True )}}'"

     - name: Check that parameter path is stored and retrieved
       assert:
        that:
         - "'{{lookup('aws_ssm', '/' ~ ssm_key_prefix ~ '/path', region=ec2_region, aws_access_key=ec2_access_key, aws_secret_key=ec2_secret_key, aws_security_token=security_token, bypath=True, shortnames=true ) | to_json }}' == '{\"toovar\": \"too value\", \"wonvar\": \"won value\"}'"

     # ============================================================
     - name: Error in case we don't find the parameter
       debug:
        msg: "'{{lookup('aws_ssm', '/' ~ ssm_key_prefix ~ '/Goodbye', region=ec2_region, aws_access_key=ec2_access_key, aws_secret_key=ec2_secret_key, aws_security_token=security_token )}}' == 'World'"
       register: result
       ignore_errors: true

     - name: assert failure from failure to find parameter
       assert:
         that:
            - 'result.failed'
            - "'Undefined AWS SSM parameter' in result.msg"


  always:

     # ============================================================
     - name: Delete key/value pair in aws parameter store
       aws_ssm_parameter_store:
         name: "/{{ssm_key_prefix}}/Hello"
         state: absent
         ec2_access_key: '{{ec2_access_key}}'
         ec2_secret_key: '{{ec2_secret_key}}'
         security_token: '{{security_token}}'
         region: '{{ec2_region}}'

     # ============================================================
     - name: Delete remaining key/value pairs in aws parameter store
       aws_ssm_parameter_store:
         name: "{{item}}"
         state: absent
         ec2_access_key: '{{ec2_access_key}}'
         ec2_secret_key: '{{ec2_secret_key}}'
         security_token: '{{security_token}}'
         region: '{{ec2_region}}'
       with_items:
         - "/{{ssm_key_prefix}}/path/wonvar"
         - "/{{ssm_key_prefix}}/path/toovar"
         - "/{{ssm_key_prefix}}/path/tree/treevar"

